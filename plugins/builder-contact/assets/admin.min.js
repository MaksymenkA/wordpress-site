'use strict';(function(x){var y=function(a,c){this.$table=x(a);this.top=window.top.document;this.init(c)};y.prototype={$table:null,app:null,init:function(a){this.app=a;this.loadExtraFields(a.values);this.makeSortable();this.events()},loadOrders:function(a,c){try{var d=JSON.parse(a.field_order)}catch(p){}d||(d={});a=this.$table[0].getElementsByTagName("tbody")[0];for(var b=a.getElementsByTagName("tr"),e=[],f=document.createDocumentFragment(),g,k=0,l=b.length;k<l;++k)b[k].classList.contains("tb_no_sort")?
g=b[k]:e.push(b[k]);b=null;e.sort(function(a,b){var g=function(a){for(var b=c.length-1;-1<b;--b)if((c[b].label===a||c[b].id===a)&&void 0!==c[b].order)return c[b].order;return!1};var h=a.classList.contains("tb_contact_new_row");var f=b.classList.contains("tb_contact_new_row");if(h){var e=a.getElementsByClassName("tb_new_field_textbox")[0].value;e=""===e?a.getElementsByClassName("tb_new_field_textbox")[0].dataset.id:e}else e=a.getElementsByClassName("tb_lb_option")[0].id;f?(b=b.getElementsByClassName("tb_new_field_textbox")[0].value,
b=""===b?a.getElementsByClassName("tb_new_field_textbox")[0].dataset.id:b):b=b.getElementsByClassName("tb_lb_option")[0].id;e=e.trim();b=b.trim();a=void 0!==d[e]?d[e]:h?g(e):!1;f=void 0!==d[b]?d[b]:f?g(b):!1;return a-f});k=0;for(l=e.length;k<l;++k)f.appendChild(e[k]);for(f.appendChild(g);a.firstChild;)a.removeChild(a.firstChild);a.appendChild(f)},loadExtraFields:function(a){var c=this.$table[0].getElementsByClassName("tb_no_sort")[0];try{var d=JSON.parse(a.field_extra).fields}catch(g){}d||(d={fields:[]});
for(var b=document.createDocumentFragment(),e=0,f=d.length;e<f;++e)b.appendChild(this.addField(d[e]));c.parentNode.insertBefore(b,c);this.loadOrders(a,d)},events:function(){var a=this;this.$table.on("click.tb_contact",".tb_new_field_action",function(c){c.preventDefault();c.stopPropagation();c=this.closest(".tb_no_sort");c.parentNode.insertBefore(a.addField({}),c);a.$table.find("tbody").sortable("refresh");a.changeObject()}).on("change.tb_contact",".tb_new_field_type",function(){a.switchField(this);
a.changeObject()}).on("click.tb_contact",".tb_add_field_option",function(c){c.preventDefault();c.stopPropagation();this.previousElementSibling.appendChild(a.render.getOptions([""]))}).on("keyup.tb_contact",'.tb_contact_new_row input[type="text"], .tb_contact_new_row textarea',function(){a.changeObject()}).on("change.tb_contact",".tb_contact_new_row .tb_new_field_required",function(){a.changeObject()}).on("click.tb_contact",".tb_contact_value_remove,.tb_contact_field_remove",function(c){c.preventDefault();
c.stopPropagation();this.classList.contains("tb_contact_value_remove")?x(this).closest("li").remove():x(this).closest(".tb_contact_new_row").remove();a.changeObject()})},makeSortable:function(){var a=this;this.$table.find("tbody").sortable({items:"tr:not(.tb_no_sort)",placeholder:"ui-state-highlight",axis:"y",containment:"parent",update:function(){a.changeObject()}})},render:{call:function(a,c){return void 0===this[c]?this._default(a,c):this[c].call(this,a,c)},setType:function(a,c){a.setAttribute("data-type",
c)},getText:function(a,c,d){var b=document.createElement(d);"textarea"!==d&&(b.type="tel"!==d?"text":"tel");a.value&&(b.value=a.value);b.className="tb_new_field_value tb_field_type_text";this.setType(b,c);return b},static:function(a,c){a=this._default(a,"textarea");a.placeholder=tb_contact_l10n.static_text;this.setType(a,"static");return a},upload:function(a,c){return document.createElement("div")},getOptions:function(a){var c=document.createDocumentFragment(),d;for(d in a){var b=document.createElement("li"),
e=document.createElement("a"),f=document.createElement("input"),g=document.createElement("i");f.type="text";f.className="tb_multi_option";f.value=a[d];e.className="tb_contact_value_remove";e.href="#";g.className="ti ti-close";b.appendChild(f);e.appendChild(g);b.appendChild(e);c.appendChild(b)}return c},_default:function(a,c){if("text"===c||"textarea"===c||"tel"===c)return this.getText(a,c,"textarea"===c?c:"input");var d=document.createElement("ul"),b=document.createElement("a"),e=document.createDocumentFragment();
d.appendChild(this.getOptions(a.value||[""]));e.appendChild(d);b.href="#";b.className="tb_add_field_option";b.textContent=tb_contact_l10n.add_option;this.setType(b,c);e.appendChild(b);return e}},addField:function(a){var c=0===Object.keys(a).length,d=a.type?a.type:"text",b=document.createElement("tr"),e=document.createElement("td"),f=document.createElement("input"),g=document.createElement("td"),k=document.createElement("div"),l=document.createElement("select"),p=document.createDocumentFragment(),
r=document.createElement("div"),u=document.createElement("div"),h=document.createElement("label"),n=document.createElement("input"),q=document.createElement("a"),t=document.createElement("i"),m=tb_contact_l10n.types,v="tb_"+tb_app.Utils.generateUniqueID();r.className="control-input";u.className="tb_new_field";k.className="selectwrapper";l.className="tb_new_field_type tb_lb_option";b.className="tb_contact_new_row";f.type="text";f.className="tb_new_field_textbox";f.value=void 0===a.label?!0===c?tb_contact_l10n.field_name:
"":a.label;f.dataset.id=void 0===a.id?"":a.id;n.type="checkbox";n.className="tb_new_field_required";n.value="required";"static"===d&&(h.style.display="none");!0===a.required&&(n.checked=!0);q.className="tb_contact_field_remove";q.href="#";t.className="ti ti-close";g.setAttribute("colspan","3");e.appendChild(f);b.appendChild(e);for(var w in m)c=document.createElement("option"),c.name=v,w===d&&(c.selected="selected"),c.value=w,c.textContent=m[w],p.appendChild(c);l.appendChild(p);k.appendChild(l);g.appendChild(k);
r.appendChild(this.render.call(a,d));u.appendChild(r);h.appendChild(n);h.appendChild(document.createTextNode(tb_contact_l10n.req));u.appendChild(h);g.appendChild(u);q.appendChild(t);g.appendChild(q);b.appendChild(g);return b},switchField:function(a){var c=a.value;a=a.closest("td").getElementsByClassName("control-input")[0];for(var d=a.closest(".tb_new_field").getElementsByClassName("tb_new_field_required")[0].parentNode;a.firstChild;)a.removeChild(a.firstChild);a.appendChild(this.render.call({},c));
d.style.display="static"===c?"none":""},changeObject:function(){for(var a=this.$table[0].getElementsByTagName("tbody")[0].getElementsByTagName("tr"),c={fields:[]},d={},b=0,e=a.length;b<e;++b)if(a[b].classList.contains("tb_contact_new_row")){var f=a[b].getElementsByClassName("tb_new_field_type")[0].options[a[b].getElementsByClassName("tb_new_field_type")[0].selectedIndex].value,g=a[b].getElementsByClassName("tb_new_field_textbox")[0].value.trim(),k="static"!==f&&!0===a[b].getElementsByClassName("tb_new_field_required")[0].checked;
switch(f){case "text":case "textarea":case "static":case "tel":var l=a[b].getElementsByClassName("tb_new_field_value")[0].value.trim();break;case "radio":case "select":case "checkbox":l=[];for(var p=a[b].getElementsByClassName("control-input")[0].getElementsByTagName("input"),r=0,u=p.length;r<u;++r){var h=p[r].value.trim();""!==h&&l.push(h)}}if(""!==l&&void 0!==l||""!==g)f={type:f,order:b},k&&(f.required=k),""!==g?f.label=g:f.id="ex"+b,void 0!==l&&""!==l&&0<l.length&&(f.value=l),c.fields.push(f)}else a[b].classList.contains("tb_no_sort")||
(g=a[b].getElementsByClassName("tb_lb_option")[0].id,d[g]=b);a=this.top.getElementById("field_extra");a.value=JSON.stringify(c);c=JSON.stringify(d);this.top.getElementById("field_order").value=c;this.app.settings.field_order=c;Themify.triggerEvent(a,"change")}};var z=null;tb_app.Constructor.contact_fields={render:function(a,c){var d=window.top;null===z&&(z=!0,d.Themify.LoadCss(tb_contact_l10n.admin_css,tb_contact_l10n.v));var b=document.createElement("table");d=document.createElement("thead");var e=
document.createElement("tbody"),f=document.createElement("tfoot"),g=document.createElement("tr"),k=document.createDocumentFragment(),l=a.options.head,p=a.options.body,r=a.options.foot,u={text:function(a,b,d){a={id:"field_"+a,placeholder:b,"class":"large",type:"text"};d&&(a.help=d);return c.create([a])},checkbox:function(a){var b={id:"field_"+a,new_line:!0,type:"checkbox",options:[{value:"",name:"yes"}]};"sendcopy_active"===a&&(b.binding={checked:{show:["field_sendcopy_subject"]},not_checked:{hide:["field_sendcopy_subject"]}});
return c.create([b])}},h;for(h in l){var n=document.createElement("th");n.textContent=l[h];k.appendChild(n)}g.appendChild(k);d.appendChild(g);k=document.createDocumentFragment();for(h in p){var q=document.createDocumentFragment();g=document.createElement("tr");for(var t in l){n=document.createElement("td");var m=null;if("f"===t)m=document.createElement("span"),n.textContent=p[h];else if("l"===t||"p"===t){if(m=h+"_",m+="l"===t?"label":"placeholder",m=u.text(m,"l"===t?p[h]:l.p),"l"===t&&"message"!==
h){var v=document.createDocumentFragment(),w=u.checkbox(h+"_require");v.appendChild(m);w.querySelector(".tb_lb_option").appendChild(document.createTextNode(tb_contact_l10n.req));v.appendChild(w);m=v}}else"sh"===t&&(m=u.checkbox(h+"_active"));null!==m&&n.appendChild(m);q.appendChild(n)}g.appendChild(q);k.appendChild(g)}g=document.createElement("tr");n=document.createElement("td");q=document.createElement("a");p=document.createElement("span");q.className="tb_new_field_action";q.href="#";p.className=
"ti-plus";q.appendChild(p);q.appendChild(document.createTextNode(a.new_row));n.setAttribute("colspan","4");n.appendChild(q);g.className="tb_no_sort";g.appendChild(n);k.appendChild(g);e.appendChild(k);for(h in r)if("align"!==h){q=document.createDocumentFragment();g=document.createElement("tr");for(t in l)n=document.createElement("td"),m=null,"f"===t?n.textContent=r[h]:"l"===t?(a=u.text(h+"_label",r[h]),"send"===h?(v=document.createDocumentFragment(),p=c.select.render({id:r.align.id,options:r.align.options},
c),v.appendChild(a),v.appendChild(p),v.appendChild(document.createTextNode(r.align.label)),m=v):"optin"===h?(m=document.createDocumentFragment(),p=ThemifyConstructor.create([{type:"optin_provider",id:"optin"}]),m.appendChild(a),m.appendChild(p)):m=a,v.appendChild(w)):"sh"===t&&"send"!==h&&(m=u.checkbox(h+"_active"),"captcha"===h&&""!==tb_contact_l10n.captcha&&m.querySelector("input").addEventListener("change",function(a){a=this.closest("td").previousElementSibling;if(!0===this.checked){var b=document.createElement("div");
b.className="tb_captcha_message tb_field_error_msg";b.innerHTML=tb_contact_l10n.captcha;a.appendChild(b)}else a=a.getElementsByClassName("tb_captcha_message")[0],a.parentNode.removeChild(a)},{passive:!0})),null!==m&&n.appendChild(m),"l"===t&&"sendcopy"===h&&n.appendChild(c.create([{id:"field_"+h+"_subject",after:tb_contact_l10n.sendcopy_sub,type:"text","class":"small"}])),q.appendChild(n);g.appendChild(q);k.appendChild(g)}f.appendChild(k);b.className="contact_fields";b.appendChild(d);b.appendChild(e);
b.appendChild(f);l=g=d=e=f=p=r=null;var x=function(a){var d=new y(b,c);Themify.body.one("themify_builder_lightbox_close",function(a){d.$table.off("click.tb_contact keyup.tb_contact change.tb_contact");d=null});document.removeEventListener("tb_editing_contact",x,{once:!0})};document.addEventListener("tb_editing_contact",x,{once:!0});return b}}})(jQuery);
